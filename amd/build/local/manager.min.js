define("qtype_answersheet/local/manager",["exports","qtype_answersheet/local/state","qtype_answersheet/local/repository","core/notification","core/str","core/utils","./components/table"],(function(_exports,_state,_repository,_notification,_str,_utils,_table){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_state=_interopRequireDefault(_state),_repository=_interopRequireDefault(_repository),_notification=_interopRequireDefault(_notification);class Manager{constructor(element,questionid){_defineProperty(this,"rowNumber",0),_defineProperty(this,"questionid",void 0),_defineProperty(this,"temprowid",2),_defineProperty(this,"element",void 0),_defineProperty(this,"table","qtype_answersheet"),_defineProperty(this,"columns",[]),_defineProperty(this,"TYPES",{1:"radiochecked",2:"letterbyletter",3:"freetext"}),this.element=element,this.questionid=parseInt(questionid),this.addEventListeners(),this.getDatagrid(),this.tempfield=document.querySelector('input[name="newquestion"]')}addEventListeners(){const form=document.querySelector('[data-region="app"]');form.addEventListener("click",(e=>{let btn=e.target.closest("[data-action]");btn&&(e.preventDefault(),this.actions(btn))})),form.addEventListener("change",(e=>{const input=e.target.closest("[data-input]");input&&this.change(input);const modulename=e.target.closest('[data-region="modulename"]');modulename&&this.changeModule(modulename);const moduletype=e.target.closest('[data-region="moduletype"]');moduletype&&this.changeModule(moduletype)})),form.addEventListener("keydown",(e=>{"ArrowDown"!==e.key&&"ArrowUp"!==e.key||(this.navigate(e),e.preventDefault()),"Enter"===e.key&&e.preventDefault()})),form.addEventListener("submit",(e=>{e.preventDefault()}));let dragging=null;form.addEventListener("dragstart",(e=>{"TR"===e.target.tagName&&(dragging=e.target,e.target.effectAllowed="move")})),form.addEventListener("dragover",(e=>{e.preventDefault();const target=e.target.closest("tr");if(target&&target!==dragging&&"rows"===target.parentNode.dataset.region){const rect=target.getBoundingClientRect();e.clientY-rect.top>rect.height/2?target.parentNode.insertBefore(dragging,target.nextSibling):target.parentNode.insertBefore(dragging,target)}})),form.addEventListener("drop",(e=>{e.preventDefault()})),form.addEventListener("dragend",(e=>{const rowId=dragging.dataset.index,prevRowId=dragging.previousElementSibling?dragging.previousElementSibling.dataset.index:0,moduleId=dragging.closest('[data-region="module"]').dataset.id;_repository.default.updateSortOrder({type:"row",questionid:this.questionid,moduleid:moduleId,id:rowId,previd:prevRowId}),dragging=null,e.preventDefault()})),document.addEventListener("saveconfirm",(()=>{this.setTableData()}))}async getDatagrid(){await this.getTableData(),await this.getTableConfig()}async getTableConfig(){const response=await _repository.default.getColumns({table:this.table});await _state.default.setValue("columns",response.columns)}async getTableData(){try{const response=await _repository.default.getData({questionid:this.questionid});if(response.modules.length>0){const modules=this.parseModules(response.modules);_state.default.setValue("modules",modules)}else{const moduleid=await this.createModule(" ",0);await this.createRow(moduleid,0,0),this.getTableData()}}catch(error){_notification.default.exception(error)}}parseModules(modules){return modules.forEach((mod=>{const type=this.TYPES[mod.type];mod[type]=!0,mod.rows.map((row=>(row.cells=row.cells.map((cell=>{const column=mod.columns.find((column=>column.column==cell.column));return"select"===(cell=Object.assign({},cell,column)).type&&(cell.options=cell.options.map((option=>{const clonedOption=Object.assign({},option);return clonedOption.name==cell.value&&(clonedOption.selected=!0),clonedOption}))),cell.edit=!0,cell})),row)))})),modules}getRowObject(){return{rows:{id:"id",sortorder:"sortorder",cells:{type:"type",column:"column",value:"value"}}}}checkCellValue(cell){null!==cell.value&&"text"===cell.type&&cell.value.length>cell.length&&(cell.value=cell.value.substring(0,cell.length))}cleanModules(modules){const cleanedModules=[];return modules.forEach((module=>{const rows=module.rows,rowObject=this.getRowObject(),cleanedRows=rows.map((row=>{const cleanedRow={};return Object.keys(rowObject.rows).forEach((key=>{cleanedRow[key]=row[key]})),cleanedRow.cells=row.cells.map((cell=>{const cleanedCell={};return this.checkCellValue(cell),Object.keys(rowObject.rows.cells).forEach((key=>{cleanedCell[key]=cell[key]})),cleanedCell})),cleanedRow})),cleanedModule={};cleanedModule.id=module.moduleid,cleanedModule.sortorder=module.modulesortorder,cleanedModule.name=module.modulename,cleanedModule.type=module.type,cleanedModule.numoptions=module.numoptions,cleanedModule.rows=cleanedRows,cleanedModules.push(cleanedModule)})),cleanedModules}async setTableData(){(0,_utils.debounce)((async()=>{const saveConfirmButton=document.querySelector('[data-action="saveconfirm"]');saveConfirmButton.classList.add("saving");const modules=_state.default.getValue("modules"),cleanedModules=this.cleanModules(modules);0==this.questionid&&(this.tempfield.value=JSON.stringify(cleanedModules));await _repository.default.setData({questionid:this.questionid,modules:cleanedModules})||_notification.default.exception("No response from the server"),setTimeout((()=>{saveConfirmButton.classList.remove("saving")}),200)}),600)()}actions(btn){"addrow"===btn.dataset.action&&this.addRow(btn),"deleterow"===btn.dataset.action&&this.deleteRow(btn),"addmodule"===btn.dataset.action&&this.addModule(btn),"deletemodule"===btn.dataset.action&&this.deleteModule(btn),"saveconfirm"===btn.dataset.action&&this.setTableData(),"moduleremoveoption"===btn.dataset.action&&this.updateModuleOption(btn,!1),"moduleaddoption"===btn.dataset.action&&this.updateModuleOption(btn,!0)}async addRow(btn){const modules=_state.default.getValue("modules");let rowid=btn.dataset.id;const moduleid=btn.closest('[data-region="module"]').dataset.id,rows=modules.find((m=>m.moduleid==moduleid)).rows;-1==rowid&&(rowid=rows[rows.length-1].id);const row=await this.createRow(moduleid,rowid);row&&(rows.splice(rows.indexOf(rows.find((r=>r.id==rowid)))+1,0,row),_state.default.setValue("modules",modules),this.resetRowSortorder())}async createRow(moduleid,prevrowid){let rowid=this.temprowid++;return 0!=this.questionid&&(rowid=await _repository.default.createRow({questionid:this.questionid,moduleid:moduleid,prevrowid:prevrowid})),new Promise((resolve=>{const row={};row.id=rowid;const columns=_state.default.getValue("columns");void 0!==columns?(row.cells=columns.map((column=>structuredClone(column))),row.cells.forEach((cell=>{cell.edit=!0,cell.value="",cell[cell.type]=!0})),resolve(row)):resolve()}))}async deleteRow(btn){const modules=_state.default.getValue("modules"),rowid=btn.closest("[data-row]").dataset.index,moduleid=btn.closest('[data-region="module"]').dataset.id,module=modules.find((m=>m.moduleid==moduleid));if(0==this.questionid){const index=module.rows.findIndex((r=>r.id==rowid));return module.rows.splice(index,1),this.resetRowSortorder(),_state.default.setValue("modules",modules),new Promise((resolve=>{resolve(rowid)}))}const response=await _repository.default.deleteRow({questionid:this.questionid,rowid:rowid});return new Promise((resolve=>{if(response){const rows=module.rows,index=Array.from(btn.closest('[data-region="rows"]').children).indexOf(btn.closest("[data-row]"));rows.splice(index,1),this.resetRowSortorder(),_state.default.setValue("modules",modules)}resolve(rowid)}))}change(input){const row=input.closest("[data-row]"),cell=input.closest("[data-cell]"),value=input.value,columnid=cell.dataset.columnid,index=row.dataset.index;_state.default.getValue("modules").forEach((module=>{const rowIndex=module.rows.findIndex((r=>r.id==index));if(-1===rowIndex)return;const cellIndex=module.rows[rowIndex].cells.findIndex((c=>c.columnid==columnid));module.rows[rowIndex].cells[cellIndex].value=value,"select"===module.rows[rowIndex].cells[cellIndex].type&&module.rows[rowIndex].cells[cellIndex].options.forEach((option=>{option.selected=option.name===value}))})),this.setTableData()}changeModule(element){const moduleElement=element.closest('[data-region="module"]'),moduleid=moduleElement.dataset.id,name=moduleElement.querySelector('[data-region="modulename"]').value,type=moduleElement.querySelector('[data-region="moduletype"]').value,numoptions=moduleElement.querySelector('[data-region="numoptions"]').value;Object.values(this.TYPES).forEach((type=>{moduleElement.classList.remove(type)})),moduleElement.classList.add(this.TYPES[type]);_state.default.getValue("modules").forEach((moduleObject=>{moduleObject.moduleid==moduleid&&(moduleObject.modulename=name,moduleObject.type=parseInt(type),moduleObject.numoptions=parseInt(numoptions))})),this.updateRangeIndicator(moduleElement),this.setTableData()}updateModuleOption(btn,add){const numoptions=btn.closest('[data-region="module"]').querySelector('[data-region="numoptions"]'),value=parseInt(numoptions.value);numoptions.value=add?value+1:value-1,this.changeModule(numoptions)}async updateRangeIndicator(moduleElement){const type=moduleElement.querySelector('[data-region="moduletype"]').value,numoptions=moduleElement.querySelector('[data-region="numoptions"]').value,indicator=moduleElement.querySelector('[data-region="indicator"]'),stringname="indicator:"+this.TYPES[type],stringtemplate={options:numoptions,lastletter:String.fromCharCode(65+parseInt(numoptions)-1)};indicator.textContent=await(0,_str.get_string)(stringname,"qtype_answersheet",stringtemplate)}async deleteModule(btn){const modules=_state.default.getValue("modules"),moduleid=btn.closest('[data-region="module"]').dataset.id,module=modules.find((m=>m.moduleid==moduleid)),response=await _repository.default.deleteModule({questionid:this.questionid,moduleid:moduleid});return new Promise((resolve=>{if(response){const index=modules.indexOf(module);modules.splice(index,1),_state.default.setValue("modules",modules)}resolve(moduleid)}))}async createModule(name,index){let type=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,numoptions=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4;const id=await _repository.default.createModule({name:name,questionid:this.questionid,sortorder:index,type:type,numoptions:numoptions});return new Promise((resolve=>{resolve(id)}))}async addModule(){const modules=_state.default.getValue("modules"),index=modules.length;let moduleid=modules.length+1;0!=this.questionid&&(moduleid=await this.createModule(" ",index,1,4));const row=await this.createRow(moduleid,0),module={moduleid:moduleid,modulesortorder:index+1,modulename:" ",type:1,numoptions:4,indicator:"A - "+String.fromCharCode(68),rows:[row]};module[this.TYPES[1]]=!0,modules.push(module),_state.default.setValue("modules",modules)}getRow(rowid){return _state.default.getValue("modules").reduce(((acc,module)=>acc.concat(module.rows)),[]).find((r=>r.id==rowid))}resetRowSortorder(){const modules=_state.default.getValue("modules");modules.forEach((module=>{module.rows.forEach(((row,index)=>{row.sortorder=index}))})),_state.default.setValue("modules",modules)}navigate(e){const currentIndex=e.target.closest("[data-row]").dataset.index,currentColumn=e.target.closest("[data-cell]").dataset.columnid,allRows=document.querySelectorAll("[data-row]");for(let i=0;i<allRows.length;i++)if(allRows[i].dataset.index==currentIndex){if("ArrowDown"===e.key&&i<allRows.length-1){const nextInput=allRows[i+1].querySelector('[data-columnid="'.concat(currentColumn,'"] input'));nextInput&&nextInput.focus()}if("ArrowUp"===e.key&&i>0){const previousInput=allRows[i-1].querySelector('[data-columnid="'.concat(currentColumn,'"] input'));previousInput&&previousInput.focus()}}if("ArrowRight"===e.key){const nextColumn=e.target.closest("[data-cell]").nextElementSibling;nextColumn&&nextColumn.focus()}if("ArrowLeft"===e.key){const previousColumn=e.target.closest("[data-cell]").previousElementSibling;previousColumn&&previousColumn.focus()}}}var _default={init:(element,questionid)=>{new Manager(element,questionid)}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=manager.min.js.map